<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BUS Admin Panel</title>
<style>
  body { font-family: Arial, sans-serif; margin:0; background:#F6F4EF; color:#333; }
  header { background:#0B3D2E; color:#E0B21B; text-align:center; padding:25px 15px; }
  h1 { margin:0; font-size:2rem; }
  .nav { display:flex; justify-content:center; gap:12px; flex-wrap:wrap; margin:20px 15px; }
  .nav button { background:#0B3D2E; color:#E0B21B; border:none; padding:10px 18px; border-radius:6px; cursor:pointer; font-weight:bold; transition:all 0.2s; }
  .nav button.active { background:#0A1F16; transform:scale(1.05); }
  .section { max-width:900px; margin:20px auto; padding:20px; display:none; background:#fff; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
  .section.active { display:block; }
  input, textarea, select { width:100%; padding:10px; margin:8px 0 12px; border-radius:6px; border:1px solid #ccc; box-sizing:border-box; }
  button.submit-btn, button.login-btn { background:#0B3D2E; color:#E0B21B; border:none; padding:12px 24px; border-radius:6px; cursor:pointer; font-weight:bold; transition:all 0.2s; }
  button.submit-btn:hover, button.login-btn:hover { background:#0A1F16; }
  .item-card { border:1px solid #ddd; padding:12px; margin-bottom:12px; border-radius:8px; display:flex; justify-content:space-between; align-items:center; background:#f9f9f9; transition: all 0.4s; }
  .item-card button { background:#c0392b; color:white; border:none; padding:6px 12px; border-radius:4px; cursor:pointer; }
  .item-card.deleting { opacity:0.4; background:#ffebee; }
  .status, .login-status { margin:15px 0; font-weight:bold; text-align:center; min-height:1.5em; }
  #loginSection { max-width:450px; margin:60px auto; padding:30px; background:#fff; border-radius:10px; box-shadow:0 4px 15px rgba(0,0,0,0.15); }
  #loginSection h2 { color:#0B3D2E; text-align:center; margin-bottom:25px; }
  #adminContent { display:none; }
  .hidden { display:none !important; }
</style>
</head>
<body>

<header><h1>BUS Admin Panel</h1></header>

<!-- Login Form -->
<div id="loginSection">
  <h2>Admin Login</h2>
  <input type="email" id="loginEmail" placeholder="Email" required autocomplete="email">
  <input type="password" id="loginPassword" placeholder="Password" required autocomplete="current-password">
  <button class="login-btn" onclick="loginUser()">Sign In</button>
  <div id="loginStatus" class="login-status"></div>
</div>

<!-- Admin Content -->
<div id="adminContent">
  <div class="nav">
    <button class="nav-btn active" data-section="News">News & Updates</button>
    <button class="nav-btn" data-section="Activities">Activities & Programs</button>
    <button class="nav-btn" data-section="Media">Media Gallery</button>
    <button class="nav-btn" data-section="Members">Members</button>
    <button class="nav-btn" id="signOutBtn">Sign Out</button>
  </div>

  <!-- News Section -->
  <div class="section active" id="News">
    <h2>Add News / Update</h2>
    <input type="text" id="newsTitle" placeholder="Title" required>
    <select id="newsCategory">
      <option value="Announcements">Announcements</option>
      <option value="Recruitment">Recruitment</option>
      <option value="Statements">Statements</option>
      <option value="Opinions">Youth Opinions</option>
    </select>
    <textarea id="newsContent" placeholder="Full content..." rows="6" required></textarea>
    <label>Upload Photos (ImgBB):</label>
    <input type="file" id="newsPhotos" accept="image/*" multiple>
    <button class="submit-btn" onclick="addNews()">Add News</button>
    <div id="newsStatus" class="status"></div>
    <div id="newsList"></div>
  </div>

  <!-- Activities Section -->
  <div class="section" id="Activities">
    <h2>Add Activity / Program</h2>
    <input type="text" id="activityTitle" placeholder="Title" required>
    <textarea id="activityDesc" placeholder="Description..." rows="5" required></textarea>
    <input type="date" id="activityDate" required>
    <select id="activityType">
      <option value="Upcoming">Upcoming</option>
      <option value="Past">Past</option>
      <option value="Training">Training</option>
    </select>
    <label>Upload Photos (ImgBB):</label>
    <input type="file" id="activityPhotos" accept="image/*" multiple>
    <button class="submit-btn" onclick="addActivity()">Add Activity</button>
    <div id="activityStatus" class="status"></div>
    <div id="activityList"></div>
  </div>

  <!-- Media Section -->
  <div class="section" id="Media">
    <h2>Add Media Item</h2>
    <input type="text" id="mediaTitle" placeholder="Title" required>
    <select id="mediaType">
      <option value="Photo">Photo</option>
      <option value="Video">Video</option>
      <option value="Poster">Poster</option>
      <option value="Download">Download</option>
    </select>
    <label>Upload Image (for Photo/Poster - ImgBB):</label>
    <input type="file" id="mediaImage" accept="image/*">
    <input type="text" id="mediaThumbnail" placeholder="Thumbnail URL (optional)">
    <input type="text" id="mediaURL" placeholder="Full URL / Video / Download link (if no file)">
    <button class="submit-btn" onclick="addMedia()">Add Media</button>
    <div id="mediaStatus" class="status"></div>
    <div id="mediaList"></div>
  </div>

  <!-- Members Section -->
  <div class="section" id="Members">
    <h2>Add Member</h2>
    <input type="text" id="memberName" placeholder="Name" required>
    <input type="number" id="memberAge" placeholder="Age" min="10">
    <input type="text" id="memberWard" placeholder="Ward" required>
    <input type="text" id="memberInstitution" placeholder="Institution / School">
    <select id="memberType">
      <option value="Youth">Youth</option>
      <option value="Associate">Associate</option>
    </select>
    <button class="submit-btn" onclick="addMember()">Add Member</button>
    <div id="memberList"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, doc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyC1zqdQ4toWB73hpxn-LwIRbB2QI3fw8q8",
  authDomain: "bus-party.firebaseapp.com",
  projectId: "bus-party",
  storageBucket: "bus-party.firebasestorage.app",
  messagingSenderId: "315543442057",
  appId: "1:315543442057:web:25b4aa009050c4bfcaec58",
  measurementId: "G-HP25FYHRQY"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const IMGBB_API_KEY = 'e26f20d023a0094ee31c68ded33ab41d';

const loginSection = document.getElementById('loginSection');
const adminContent = document.getElementById('adminContent');
const loginStatus = document.getElementById('loginStatus');

onAuthStateChanged(auth, (user) => {
  if (user) {
    loginSection.classList.add('hidden');
    adminContent.style.display = 'block';
  } else {
    loginSection.classList.remove('hidden');
    adminContent.style.display = 'none';
    loginStatus.textContent = '';
  }
});

window.loginUser = async () => {
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value.trim();
  loginStatus.textContent = 'Signing in...'; loginStatus.style.color = 'blue';
  try {
    await signInWithEmailAndPassword(auth, email, password);
    loginStatus.textContent = 'Login successful!'; loginStatus.style.color = 'green';
  } catch (error) {
    let msg = 'Login failed';
    if (error.code === 'auth/user-not-found') msg = 'User not found';
    else if (error.code === 'auth/wrong-password') msg = 'Incorrect password';
    else msg = error.message;
    loginStatus.textContent = msg; loginStatus.style.color = 'red';
  }
};

document.getElementById('signOutBtn').addEventListener('click', async () => {
  try { await signOut(auth); } catch (err) { console.error(err); }
});

// Tabs
document.querySelectorAll('.nav-btn:not(#signOutBtn)').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById(btn.dataset.section).classList.add('active');
  });
});

// ImgBB uploads
async function uploadToImgBB(file) {
  if (!file) return null;
  const formData = new FormData();
  formData.append('image', file);
  formData.append('key', IMGBB_API_KEY);
  const res = await fetch('https://api.imgbb.com/1/upload', { method:'POST', body:formData });
  const data = await res.json();
  if (!data.success) throw new Error(data.error?.message || 'ImgBB upload failed');
  return { url: data.data.url, thumb: data.data.thumb?.url || data.data.medium?.url || data.data.url };
}

async function uploadMultipleFiles(files) {
  const urls = [];
  for (const file of files) {
    try {
      const { url } = await uploadToImgBB(file);
      urls.push(url);
    } catch(err){
      console.error('ImgBB upload error:', err);
    }
  }
  return urls;
}

window.addNews = async () => {
  const title = document.getElementById('newsTitle').value.trim();
  const category = document.getElementById('newsCategory').value;
  const content = document.getElementById('newsContent').value.trim();
  const files = document.getElementById('newsPhotos').files;
  if(!title || !content) return alert('Title and content required');
  const status = document.getElementById('newsStatus');
  status.textContent='Uploading images...'; status.style.color='blue';
  try {
    const photos = await uploadMultipleFiles(files);
    const expiryDate = new Date();
    expiryDate.setDate(expiryDate.getDate() + 7);

    await addDoc(collection(db,'news'),{
      title, category, content, photos,
      timestamp: serverTimestamp(),
      expiryDate: expiryDate.toISOString()
    });

    status.textContent='News added successfully!'; status.style.color='green';
    document.getElementById('newsTitle').value='';
    document.getElementById('newsContent').value='';
    document.getElementById('newsPhotos').value='';
  } catch(err){
    status.textContent='Error: '+err.message; status.style.color='red';
  }
};

window.addActivity = async () => {
  const title = document.getElementById('activityTitle').value.trim();
  const desc = document.getElementById('activityDesc').value.trim();
  const date = document.getElementById('activityDate').value;
  const type = document.getElementById('activityType').value;
  const files = document.getElementById('activityPhotos').files;
  const status = document.getElementById('activityStatus');

  if (!title || !desc || !date) {
    status.textContent = 'All fields are required';
    status.style.color = 'red';
    return;
  }

  status.textContent = 'Uploading images...';
  status.style.color = 'blue';

  try {
    const photos = await uploadMultipleFiles(files);
    const expiryDate = new Date(date);
    expiryDate.setDate(expiryDate.getDate() + 1);

    await addDoc(collection(db, 'activities'), {
      title,
      description: desc,
      date,
      type,
      photos,
      timestamp: serverTimestamp(),
      expiryDate: expiryDate.toISOString()
    });

    status.textContent = 'Activity added successfully!';
    status.style.color = 'green';

    document.getElementById('activityTitle').value = '';
    document.getElementById('activityDesc').value = '';
    document.getElementById('activityDate').value = '';
    document.getElementById('activityPhotos').value = '';
  } catch (err) {
    status.textContent = 'Error: ' + err.message;
    status.style.color = 'red';
  }
};

window.addMedia = async () => {
  const title = document.getElementById('mediaTitle').value.trim();
  const type = document.getElementById('mediaType').value;
  const imageFile = document.getElementById('mediaImage').files[0];
  const thumbURL = document.getElementById('mediaThumbnail').value.trim();
  const mediaURL = document.getElementById('mediaURL').value.trim();
  const status = document.getElementById('mediaStatus');

  if (!title) {
    status.textContent = 'Title is required';
    status.style.color = 'red';
    return;
  }

  status.textContent = 'Uploading...';
  status.style.color = 'blue';

  try {
    let image = null;
    let thumbnail = thumbURL || null;

    if (imageFile) {
      const upload = await uploadToImgBB(imageFile);
      image = upload.url;
      if (!thumbnail) thumbnail = upload.thumb;
    }

    await addDoc(collection(db, 'media'), {
      title,
      type,
      image,
      thumbnail,
      url: mediaURL || null,
      timestamp: serverTimestamp()
    });

    status.textContent = 'Media added successfully!';
    status.style.color = 'green';

    document.getElementById('mediaTitle').value = '';
    document.getElementById('mediaImage').value = '';
    document.getElementById('mediaThumbnail').value = '';
    document.getElementById('mediaURL').value = '';
  } catch (err) {
    status.textContent = 'Error: ' + err.message;
    status.style.color = 'red';
  }
};

window.addMember = async () => {
  const name = document.getElementById('memberName').value.trim();
  const age = document.getElementById('memberAge').value;
  const ward = document.getElementById('memberWard').value.trim();
  const institution = document.getElementById('memberInstitution').value.trim();
  const type = document.getElementById('memberType').value;
  if(!name || !ward) return alert('Name and ward are required');

  await addDoc(collection(db,'members'),{
    name, age, ward, institution, type,
    timestamp:serverTimestamp()
  });

  document.getElementById('memberName').value='';
  document.getElementById('memberAge').value='';
  document.getElementById('memberWard').value='';
  document.getElementById('memberInstitution').value='';
};

// ────────────────────────────────────────────────
//              FIXED LIST + DELETE FUNCTION
// ────────────────────────────────────────────────
function fetchList(coll, containerId) {
  const container = document.getElementById(containerId);
  const q = query(collection(db, coll), orderBy('timestamp', 'desc'));

  onSnapshot(q, snapshot => {
    container.innerHTML = '';
    snapshot.forEach(d => {
      const data = d.data();
      const title = data.title || data.name || 'Item';
      const type = data.category || data.type || '';

      const div = document.createElement('div');
      div.className = 'item-card';

      const span = document.createElement('span');
      span.textContent = `${title} ${type ? '(' + type + ')' : ''}`;
      div.appendChild(span);

      const delBtn = document.createElement('button');
      delBtn.textContent = 'Delete';
      delBtn.addEventListener('click', async () => {
        if (!confirm('Delete this item?')) return;

        delBtn.disabled = true;
        delBtn.textContent = 'Deleting...';
        div.classList.add('deleting');

        try {
          await deleteDoc(doc(db, coll, d.id));
          // Optional: smooth removal
          setTimeout(() => div.remove(), 400);
        } catch (err) {
          console.error('Delete failed:', err);
          alert('Delete failed: ' + err.message);
          delBtn.disabled = false;
          delBtn.textContent = 'Delete';
          div.classList.remove('deleting');
        }
      });

      div.appendChild(delBtn);
      container.appendChild(div);
    });
  }, error => {
    console.error("Snapshot error:", error);
  });
}

// Load all lists
['news', 'activities', 'media', 'members'].forEach(coll => {
  fetchList(coll, coll + 'List');
});

// Auto-remove expired items
async function removeExpired(collectionName) {
  const now = new Date().toISOString();
  const snapshot = await getDocs(collection(db, collectionName));
  snapshot.forEach(async docSnap => {
    const data = docSnap.data();
    if (data.expiryDate && data.expiryDate <= now) {
      await deleteDoc(doc(db, collectionName, docSnap.id));
      console.log(`Deleted expired ${collectionName}: ${data.title || data.name}`);
    }
  });
}

// Run on load + every 10 minutes
['news', 'activities'].forEach(coll => removeExpired(coll));
setInterval(() => {
  ['news', 'activities'].forEach(coll => removeExpired(coll));
}, 10 * 60 * 1000);

</script>
</body>
      </html>

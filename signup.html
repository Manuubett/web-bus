<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BUS Youth Ambassadors – Membership</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #0B3D2E;
      --accent: #E0B21B;
      --light: #F8F7F2;
      --gray: #6B7280;
      --error: #DC2626;
      --success: #059669;
    }
    :root {
      --safe-top: env(safe-area-inset-top, 24px);
    }

    body {
      padding-top: var(--safe-top);
    }
    
    *{margin:0;padding:0;box-sizing:border-box;}
    body{
      font-family:'Inter', sans-serif;
      background:var(--light);
      color:#1F2937;
      min-height:100vh;
      line-height:1.5;
    }
    
    .watermark {
      position: fixed;
      inset: 0;
      background-image: url("https://i.ibb.co/sp6WxLyL/croc.webp");
      background-repeat: no-repeat;
      background-position: center;
      background-size: 100%;
      opacity: 0.17;
      pointer-events: none;
      z-index: 0;
    }
    
    header{
      background:var(--primary);
      color:white;
      padding:1.5rem;
      text-align:center;
      border-bottom: 4px solid var(--accent);
    }
    
    header h1{
      font-size:1.8rem;
      margin-bottom:0.3rem;
      font-weight:700;
    }
    
    .payment-banner {
      background: linear-gradient(135deg, var(--accent) 0%, #f0c24a 100%);
      color: var(--primary);
      padding: 0.8rem;
      text-align: center;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 100;
      font-size: 0.95rem;
    }
    
    .container{
      max-width:480px;
      margin:2rem auto;
      padding:1.5rem;
      background:white;
      border-radius:12px;
      box-shadow:0 5px 15px rgba(0,0,0,0.08);
    }
    
    .form-wrapper{
      display: block;
    }
    
    h2{
      color:var(--primary);
      text-align:center;
      margin-bottom:1.5rem;
      font-size:1.5rem;
    }
    
    .form-group{
      margin-bottom:1rem;
      position: relative;
    }
    
    label{
      display:block;
      margin-bottom:0.3rem;
      font-weight:500;
      font-size:0.9rem;
    }
    
    input, select, button{
      width:100%;
      padding:0.8rem;
      border-radius:8px;
      border:1px solid #d1d5db;
      font-size:1rem;
      font-family:inherit;
    }
    
    input:focus, select:focus{
      outline:none;
      border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(11, 61, 46, 0.1);
    }
    
    .password-toggle {
      position: absolute;
      right: 12px;
      top: 38px;
      background: none;
      border: none;
      color: var(--gray);
      cursor: pointer;
      width: auto;
      padding: 0;
      font-size: 1rem;
    }
    
    .password-toggle:hover {
      color: var(--primary);
    }
    
    .forgot-password {
      text-align: right;
      margin-top: -0.5rem;
      margin-bottom: 1rem;
    }
    
    .forgot-password a {
      color: var(--primary);
      text-decoration: none;
      font-size: 0.85rem;
      font-weight: 500;
    }
    
    .forgot-password a:hover {
      text-decoration: underline;
    }
    
    button{
      background:var(--primary);
      color:white;
      border:none;
      font-weight:600;
      cursor:pointer;
      transition:all 0.2s ease;
      margin-top:0.5rem;
    }
    
    button:hover{
      background:#08251c;
      transform:translateY(-1px);
    }
    
    button:active{
      transform:translateY(0);
    }
    
    button.secondary {
      background: var(--gray);
    }
    
    button.secondary:hover {
      background: #4B5563;
    }
    
    .message{
      padding:0.8rem;
      margin-top:1rem;
      border-radius:6px;
      text-align:center;
      font-size:0.9rem;
      display:none;
    }
    
    .success{
      background:#ecfdf5;
      color:var(--success);
      border:1px solid #a7f3d0;
    }
    
    .error{
      background:#fef2f2;
      color:var(--error);
      border:1px solid #fecaca;
    }
    
    .toggle-link{
      text-align:center;
      margin-top:1.5rem;
      font-size:0.9rem;
      color:var(--gray);
    }
    
    .toggle-link a{
      color:var(--primary);
      text-decoration:none;
      font-weight:600;
      cursor:pointer;
    }
    
    .toggle-link a:hover{
      text-decoration:underline;
    }
    
    small{
      display:block;
      margin-top:0.3rem;
      font-size:0.75rem;
      color:var(--gray);
    }
    
    .spinner{
      margin:1rem auto;
      width:30px;
      height:30px;
      border:3px solid #f3f3f3;
      border-top:3px solid var(--primary);
      border-radius:50%;
      animation:spin 1s linear infinite;
    }
    
    @keyframes spin{
      0%{transform:rotate(0deg);}
      100%{transform:rotate(360deg);}
    }
    
    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      display: none;
    }
    
    .modal {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      max-width: 400px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal h3 {
      margin-bottom: 1rem;
      color: var(--primary);
    }
    
    .modal-actions {
      display: flex;
      gap: 1rem;
      margin-top: 1.5rem;
    }
    
    .modal-actions button {
      flex: 1;
    }
    
    footer{
      text-align:center;
      padding:2rem 1rem;
      color:var(--gray);
      font-size:0.85rem;
      margin-top:2rem;
    }
    
    .site-footer{
      text-align:center;
      padding:2rem 1rem;
      background:#ffffff;
      border-top:1px solid #e5e7eb;
      color:var(--gray);
    }

    .footer-profile{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:0.4rem;
    }

    .footer-profile img{
      width:45px;
      height:45px;
      border-radius:50%;
      object-fit:cover;
      border:2px solid var(--accent);
    }

    .footer-socials{
      margin:0.8rem 0;
    }

    .footer-socials a{
      margin:0 8px;
      color:var(--primary);
      font-size:1.2rem;
      transition:0.2s;
    }

    .footer-socials a:hover{
      color:var(--accent);
    }
    
    @media (max-width:500px){
      .container{
        margin:1rem auto;
        padding:1.2rem;
        border-radius:8px;
      }
      
      header{
        padding:1.2rem;
      }
      
      header h1{
        font-size:1.5rem;
      }
      
      .payment-banner{
        font-size:0.85rem;
        padding:0.7rem;
      }
      
      .modal {
        padding: 1.5rem;
      }
    }
  </style>
</head>
<body>
<iframe
  id="footerFrame"
  src=""
  style="
    width:100%;
    height:80vh;
    border:none;
    display:none;
    background:#fff;
  ">
</iframe>
  <div class="watermark"></div>
  <div class="payment-banner">
    Pay <strong>KSh 400</strong> (Membership + T-Shirt) to M-Pesa Till <strong>3628644</strong>
  </div>

  <header>
    <h1>BUS Youth Ambassadors</h1>
    <p>Embu • Kenya</p>
  </header>

  <div class="container">
    
    <!-- Login Form -->
    <div class="form-wrapper" id="loginContainer">
      <h2>Welcome Back</h2>
      
      <form id="loginForm">
        <div class="form-group">
          <label for="loginEmail">Email</label>
          <input type="email" id="loginEmail" placeholder="email@example.com" required>
        </div>
        
        <div class="form-group">
          <label for="loginPassword">Password</label>
          <input type="password" id="loginPassword" placeholder="••••••••" required>
          <button type="button" class="password-toggle" id="loginPasswordToggle">
            <i class="far fa-eye"></i>
          </button>
        </div>
        
        <div class="forgot-password">
          <a href="#" id="showForgotPassword">Forgot Password?</a>
        </div>
        
        <button type="submit">Login</button>
        <div id="loginMsg" class="message"></div>
      </form>
      
      <div class="toggle-link">
        New user? <a id="showRegistration">Register Here</a>
      </div>
    </div>

    <!-- Registration Form -->
    <div class="form-wrapper" id="registrationContainer" style="display:none;">
      <h2>Complete Registration</h2>
      
      <div style="background:#f0f9ff;padding:0.8rem;border-radius:8px;margin-bottom:1rem;font-size:0.9rem;">
        Remember to pay <strong>KSh 400</strong> to Till <strong>3628644</strong>
      </div>
      
      <form id="registrationForm">
        <div class="form-group">
          <label for="nationalId">National ID</label>
          <input type="text" id="nationalId" placeholder="12345678" required>
        </div>

        <div class="form-group">
          <label for="fullName">Full Name</label>
          <input type="text" id="fullName" placeholder="John Kamau" required>
        </div>

        <div class="form-group">
          <label for="dobYear">Year of Birth</label>
          <input type="number" id="dobYear" placeholder="YYYY" min="1990" max="2006" required>
          <small>Must be between 1990 and 2006</small>
        </div>

        <div class="form-group">
          <label for="phone">Phone Number</label>
          <input type="tel" id="phone" placeholder="0712345678" required pattern="[0-9]{10}">
          <small>10 digits starting with 07</small>
        </div>

        <div class="form-group">
          <label for="constituency">Constituency</label>
          <select id="constituency" required>
            <option value="">Select</option>
            <option value="Manyatta">Manyatta</option>
            <option value="Runyenjes">Runyenjes</option>
            <option value="Mbeere North">Mbeere North</option>
            <option value="Mbeere South">Mbeere South</option>
          </select>
        </div>

        <div class="form-group">
          <label for="ward">Ward</label>
          <select id="ward" required>
            <option value="">Select Ward</option>
          </select>
        </div>

        <div class="form-group">
          <label for="tshirt">T-Shirt Size</label>
          <select id="tshirt">
            <option value="">Select Size</option>
            <option value="S">Small</option>
            <option value="M">Medium</option>
            <option value="L">Large</option>
            <option value="XL">XL</option>
          </select>
          <small>Included with registration</small>
        </div>

        <div class="form-group">
          <label for="email">Email</label>
          <input type="email" id="email" placeholder="you@example.com" required>
        </div>

        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" id="password" placeholder="••••••••" required minlength="6">
          <button type="button" class="password-toggle" id="regPasswordToggle">
            <i class="far fa-eye"></i>
          </button>
        </div>

        <div class="form-group">
          <label for="confirmPassword">Confirm Password</label>
          <input type="password" id="confirmPassword" placeholder="••••••••" required minlength="6">
          <button type="button" class="password-toggle" id="confirmPasswordToggle">
            <i class="far fa-eye"></i>
          </button>
        </div>

        <button type="submit">Register & Proceed to Payment</button>
        <div id="regMsg" class="message"></div>
      </form>
      
      <div class="toggle-link">
        Have an account? <a id="showLogin">Login</a>
      </div>
    </div>

    <!-- Payment Step -->
    <div class="form-wrapper" id="paymentContainer" style="display:none;">
      <h2>Complete Payment</h2>
      
      <div style="text-align:center;margin-bottom:1.5rem;">
        <div style="font-size:1.2rem;margin-bottom:0.5rem;color:var(--primary);">
          <strong>KSh 400</strong>
        </div>
        <div style="background:#f0f9ff;padding:1rem;border-radius:8px;">
          <div style="font-size:1.1rem;margin-bottom:0.5rem;">
            <strong>M-Pesa Till: 3628644</strong>
          </div>
          <div style="font-size:0.9rem;color:var(--gray);">
            Pay to activate your membership
          </div>
        </div>
      </div>
      
      <div class="spinner" id="paymentSpinner"></div>
      <button id="refreshStatus">Check Payment Status</button>
      <div id="paymentMsg" class="message"></div>
    </div>

  </div>
  
  <!-- Forgot Password Modal -->
  <div class="modal-overlay" id="forgotPasswordModal">
    <div class="modal">
      <h3>Reset Password</h3>
      <p>Enter your email address and we'll send you a password reset link.</p>
      
      <form id="forgotPasswordForm">
        <div class="form-group">
          <label for="resetEmail">Email Address</label>
          <input type="email" id="resetEmail" placeholder="email@example.com" required>
        </div>
        
        <div id="resetMsg" class="message"></div>
        
        <div class="modal-actions">
          <button type="button" id="cancelForgotPassword" class="secondary">Cancel</button>
          <button type="submit">Send Reset Link</button>
        </div>
      </form>
    </div>
  </div>
  
  <footer class="site-footer">
    <div class="footer-profile">
      <img src="https://i.ibb.co/XrWV0dbP/kivuti.webp" alt="Profile" />
      <p>Powered by <strong>Lenny Kivuti</strong></p>
    </div>

    <div class="footer-socials">
      <a href="https://www.facebook.com/share/p/1CuYqHMULi/" title="Facebook"><i class="fab fa-facebook-f"></i></a>
      <a href="#" title="Twitter / X"><i class="fab fa-x-twitter"></i></a>
      <a href="#" title="Instagram"><i class="fab fa-instagram"></i></a>
      <a href="https://chat.whatsapp.com/CtWoN1znq1X2eiES81Eomm?mode=gi_t" title="WhatsApp"><i class="fab fa-whatsapp"></i></a>
    </div>

    <small>BUS Youth Ambassadors • Embu, Kenya</small>
    <div class="footer-links">
  <a href="about.html" onclick="loadFooterPage('about.html')">About Us</a>
  <a href="contact.html" onclick="loadFooterPage('contact.html')">Contact Us</a>
  <a href="privacy.html" onclick="loadFooterPage('privacy.html')">Privacy Policy</a>
  <a href="terms.html" onclick="loadFooterPage('terms.html')">Terms of Service</a>
</div>
  </footer>
  

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
function loadFooterPage(page) {
  const frame = document.getElementById('footerFrame');
  frame.src = page;
  frame.style.display = 'block';
  frame.scrollIntoView({ behavior: 'smooth' });
}
</script>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyC1zqdQ4toWB73hpxn-LwIRbB2QI3fw8q8",
      authDomain: "bus-party.firebaseapp.com",
      projectId: "bus-party",
      storageBucket: "bus-party.appspot.com",
      messagingSenderId: "315543442057",
      appId: "1:315543442057:web:25b4aa009050c4bfcaec58"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // DOM Elements
    const loginContainer = document.getElementById('loginContainer');
    const registrationContainer = document.getElementById('registrationContainer');
    const paymentContainer = document.getElementById('paymentContainer');
    const forgotPasswordModal = document.getElementById('forgotPasswordModal');
    
    const loginForm = document.getElementById('loginForm');
    const registrationForm = document.getElementById('registrationForm');
    const forgotPasswordForm = document.getElementById('forgotPasswordForm');
    
    // Password toggle buttons
    const loginPasswordToggle = document.getElementById('loginPasswordToggle');
    const regPasswordToggle = document.getElementById('regPasswordToggle');
    const confirmPasswordToggle = document.getElementById('confirmPasswordToggle');
    
    // Password fields
    const loginPassword = document.getElementById('loginPassword');
    const regPassword = document.getElementById('password');
    const confirmPassword = document.getElementById('confirmPassword');
    
    // Navigation elements
    document.getElementById('showRegistration').onclick = showRegistrationScreen;
    document.getElementById('showLogin').onclick = showLoginScreen;
    document.getElementById('refreshStatus').onclick = checkPaymentStatus;
    document.getElementById('showForgotPassword').onclick = showForgotPasswordModal;
    document.getElementById('cancelForgotPassword').onclick = hideForgotPasswordModal;

    // Ward data
    const wardsData = {
      "Manyatta": ["Kithimu", "Mbeti North", "Kirimari", "Nginda", "Ruguru Ngandori", "Gatu South"],
      "Runyenjes": ["Kyeni South", "Kyeni North", "Gaturi North", "Kagaari North", "Kagaari South", "Runyenjes Central"],
      "Mbeere North": ["Evurore", "Nthawa", "Muminji"],
      "Mbeere South": ["Mavuria", "Makima", "Mbeti South", "Mwea", "Kiambere"]
    };

    // ==================== PASSWORD TOGGLE FUNCTIONS ====================
    
    loginPasswordToggle.addEventListener('click', function() {
      const type = loginPassword.getAttribute('type') === 'password' ? 'text' : 'password';
      loginPassword.setAttribute('type', type);
      this.innerHTML = type === 'password' ? '<i class="far fa-eye"></i>' : '<i class="far fa-eye-slash"></i>';
    });
    
    regPasswordToggle.addEventListener('click', function() {
      const type = regPassword.getAttribute('type') === 'password' ? 'text' : 'password';
      regPassword.setAttribute('type', type);
      this.innerHTML = type === 'password' ? '<i class="far fa-eye"></i>' : '<i class="far fa-eye-slash"></i>';
    });
    
    confirmPasswordToggle.addEventListener('click', function() {
      const type = confirmPassword.getAttribute('type') === 'password' ? 'text' : 'password';
      confirmPassword.setAttribute('type', type);
      this.innerHTML = type === 'password' ? '<i class="far fa-eye"></i>' : '<i class="far fa-eye-slash"></i>';
    });

    // ==================== FORGOT PASSWORD FUNCTIONS ====================
    
    function showForgotPasswordModal() {
      forgotPasswordModal.style.display = 'flex';
      document.getElementById('resetMsg').style.display = 'none';
      document.getElementById('resetEmail').value = '';
    }
    
    function hideForgotPasswordModal() {
      forgotPasswordModal.style.display = 'none';
    }
    
    forgotPasswordForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const msg = document.getElementById('resetMsg');
      msg.style.display = 'none';
      
      const email = document.getElementById('resetEmail').value.trim();
      
      auth.sendPasswordResetEmail(email)
        .then(() => {
          msg.textContent = 'Password reset email sent! Check your inbox or check  spam in your email.';
          msg.className = 'message success';
          msg.style.display = 'block';
          
          // Hide modal after 3 seconds
          setTimeout(() => {
            hideForgotPasswordModal();
            showLoginScreen();
          }, 3000);
        })
        .catch((error) => {
          msg.textContent = getErrorMessage(error.code);
          msg.className = 'message error';
          msg.style.display = 'block';
        });
    });

    // ==================== SCREEN MANAGEMENT ====================
    
    function showLoginScreen() {
      loginContainer.style.display = 'block';
      registrationContainer.style.display = 'none';
      paymentContainer.style.display = 'none';
      hideForgotPasswordModal();
    }

    function showRegistrationScreen() {
      loginContainer.style.display = 'none';
      registrationContainer.style.display = 'block';
      paymentContainer.style.display = 'none';
      hideForgotPasswordModal();
    }

    function showPaymentScreen() {
      loginContainer.style.display = 'none';
      registrationContainer.style.display = 'none';
      paymentContainer.style.display = 'block';
      hideForgotPasswordModal();
      
      checkPaymentStatus();
    }

    // ==================== MAIN FUNCTIONS ====================
    
    // Ward dropdown logic
    document.getElementById('constituency').addEventListener('change', function() {
      const wardSelect = document.getElementById('ward');
      wardSelect.innerHTML = '<option value="">Select Ward</option>';
      const wards = wardsData[this.value] || [];
      wards.forEach(ward => {
        const option = document.createElement('option');
        option.value = ward;
        option.textContent = ward;
        wardSelect.appendChild(option);
      });
    });

    async function checkIfAlreadyRegistered(nationalId) {
      try {
        const query = await db.collection('members')
          .where('nationalId', '==', nationalId)
          .limit(1)
          .get();
        
        if (!query.empty) {
          const userData = query.docs[0].data();
          if (userData.paidTill) {
            alert('You are already registered. Redirecting...');
            window.location.href = 'main.html';
          } else {
            showPaymentScreen();
          }
        }
      } catch (error) {
        console.error('Error checking registration:', error);
      }
    }

    // Login form// Updated Login form
loginForm.addEventListener('submit', function (e) {
  e.preventDefault();

  const msg = document.getElementById('loginMsg');
  msg.style.display = 'none';

  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;

  auth.signInWithEmailAndPassword(email, password)
    .then((userCred) => {
      const user = userCred.user;
      console.log('Logged in UID:', user.uid);

      const memberRef = db.collection('members').doc(user.uid);

      return memberRef.get().then((memberDoc) => {
        if (!memberDoc.exists) {
          // NEW USER TRYING TO LOGIN DIRECTLY
          // Sign them out and show registration form
          auth.signOut().then(() => {
            msg.textContent = 'No account found. Please register first.';
            msg.className = 'message error';
            msg.style.display = 'block';
            showRegistrationScreen();
          });
          return Promise.reject(new Error('New user trying to login'));
        }
        return memberDoc;
      });
    })
    .then((memberDoc) => {
      if (!memberDoc) return; // Skip if memberDoc is undefined
      
      const userData = memberDoc.data();

      if (userData.paidTill) {
        // User is confirmed/approved - go directly to main page
        window.location.href = 'main.html';
      } else {
        // User needs to complete payment
        showPaymentScreen();
      }
    })
    .catch((error) => {
      console.error('Login error:', error);
      // Don't show error message if it's our custom "new user" error
      if (error.message !== 'New user trying to login') {
        msg.textContent = getErrorMessage(error.code);
        msg.className = 'message error';
        msg.style.display = 'block';
      }
    });
});


    // Registration form
    registrationForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const msg = document.getElementById('regMsg');
      msg.style.display = 'none';
      
      const nationalId = document.getElementById('nationalId').value.trim();
      const fullName = document.getElementById('fullName').value.trim();
      const dobYear = document.getElementById('dobYear').value;
      const phone = document.getElementById('phone').value.trim();
      const constituency = document.getElementById('constituency').value;
      const ward = document.getElementById('ward').value;
      const tshirt = document.getElementById('tshirt').value;
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const confirmPasswordValue = document.getElementById('confirmPassword').value;
      
      // Validation
      if (password !== confirmPasswordValue) {
        msg.textContent = 'Passwords do not match';
        msg.className = 'message error';
        msg.style.display = 'block';
        return;
      }
      
      if (!constituency || !ward) {
        msg.textContent = 'Please select constituency and ward';
        msg.className = 'message error';
        msg.style.display = 'block';
        return;
      }
      
      if (!phone.match(/^07\d{8}$/)) {
        msg.textContent = 'Please enter a valid phone number (0712345678)';
        msg.className = 'message error';
        msg.style.display = 'block';
        return;
      }
      
      if (dobYear < 1990 || dobYear > 2006) {
        msg.textContent = 'Year of birth must be between 1990 and 2006';
        msg.className = 'message error';
        msg.style.display = 'block';
        return;
      }
      
      try {
        // Check if ID already registered
        const existingQuery = await db.collection('members')
          .where('nationalId', '==', nationalId)
          .limit(1)
          .get();
        
        if (!existingQuery.empty) {
          msg.textContent = 'This National ID is already registered';
          msg.className = 'message error';
          msg.style.display = 'block';
          return;
        }
        
        // Create user account
        const userCred = await auth.createUserWithEmailAndPassword(email, password);
        const user = userCred.user;
        
        // Generate membership ID
        const year = new Date().getFullYear();
        const snap = await db.collection('members').get();
        const membershipId = `Y-${year}-${(snap.size + 1).toString().padStart(4, '0')}`;
        
        // Save to Firestore
        await db.collection('members').doc(user.uid).set({
          nationalId,
          fullName,
          dobYear,
          phone,
          constituency,
          ward,
          tshirt,
          email,
          membershipId,
          membership: 'Youth',
          paidTill: false,
          registeredAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showPaymentScreen();
      } catch (error) {
        if (error.code === 'auth/email-already-in-use') {
          msg.textContent = 'Email already registered. Please login instead.';
        } else {
          msg.textContent = 'Error: ' + error.message;
        }
        msg.className = 'message error';
        msg.style.display = 'block';
      }
    });

    // Check payment status
    async function checkPaymentStatus() {
      const msg = document.getElementById('paymentMsg');
      const spinner = document.getElementById('paymentSpinner');
      msg.style.display = 'none';
      spinner.style.display = 'block';
      
      const user = auth.currentUser;
      
      if (!user) {
        spinner.style.display = 'none';
        msg.textContent = 'Please login first';
        msg.className = 'message error';
        msg.style.display = 'block';
        return;
      }
      
      try {
        const userDoc = await db.collection('members').doc(user.uid).get();
        
        spinner.style.display = 'none';
        
        if (userDoc.exists) {
          const userData = userDoc.data();
          
          if (userData.paidTill) {
            // User is confirmed/approved - redirect to main page
            msg.textContent = 'Payment confirmed! Redirecting...';
            msg.className = 'message success';
            msg.style.display = 'block';
            setTimeout(() => {
              window.location.href = 'main.html';
            }, 2000);
          } else {
            msg.textContent = 'Payment still pending. Please pay KSh 400 to Till 3628644.';
            msg.className = 'message error';
            msg.style.display = 'block';
          }
        } else {
          msg.textContent = 'User not found. Please start over.';
          msg.className = 'message error';
          msg.style.display = 'block';
        }
      } catch (error) {
        spinner.style.display = 'none';
        msg.textContent = 'Error checking payment status';
        msg.className = 'message error';
        msg.style.display = 'block';
      }
    }

    // Error message helper
    function getErrorMessage(errorCode) {
  const messages = {
    'auth/user-not-found': 'No account found with this email. Please register first.',
    'auth/wrong-password': 'Incorrect password',
    'auth/invalid-email': 'Invalid email address',
    'auth/too-many-requests': 'Too many attempts. Try again later',
    'auth/user-disabled': 'Account has been disabled',
    'auth/operation-not-allowed': 'Email/password sign-in is not enabled',
    'auth/network-request-failed': 'Network error. Please check your connection',
    'auth/email-already-in-use': 'Email already registered',
    'auth/weak-password': 'Password should be at least 6 characters',
    'auth/invalid-credential': 'Invalid email or password'
  };
  return messages[errorCode] || 'An error occurred. Please try again.';
}
    
    // ==================== INITIALIZATION ====================
    
    window.addEventListener('DOMContentLoaded', () => {
      // Check if user is already logged in
      auth.onAuthStateChanged(async (user) => {
        if (user) {
          const userDoc = await db.collection('members').doc(user.uid).get();
          if (userDoc.exists) {
            const userData = userDoc.data();
            
            if (userData.paidTill) {
              // User is confirmed/approved - redirect to main page
              window.location.href = 'main.html';
            } else {
              // User needs to complete payment
              showPaymentScreen();
            }
          }
        } else {
          showLoginScreen();
        }
      });
    });
  </script>
</body>
</html>
